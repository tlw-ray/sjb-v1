<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>创建或加入房间</title>
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script>
        var playerActionURL;
        $(document).ready(function(){
            // //获得登陆用户信息，并建立WebSocket连接
            // $.ajax({
            //     url: '/onk/who',
            //     type: 'GET',
            //     Accept: 'application/json',
            //     contentType: 'application/json',
            //     success: function(userName){
            //         $('#who_span').text(userName)
            //         var roomID = $('#room_id_span').html()
            //         var endpointURL = '/onk/endpoint'
            //         var topicURL = '/topic/' + roomID
            //         var queueURL = '/user/queue/' + roomID
            //         console.log(topicURL)
            //         console.log(queueURL)
            //         var queueSock = new SockJS(endpointURL)
            //         var queueStomp = Stomp.over(queueSock)
            //         queueStomp.connect({}, function(frame){
            //             console.log(frame)
            //             queueStomp.subscribe(queueURL, function(message){
            //                 var xskrMessage = JSON.parse(message.body)
            //                 showMessage(xskrMessage.message)
            //                 if(xskrMessage.entity == 'LOCK_READY_ACTION'){
            //                     //游戏开始，锁定Ready勾选框
            //                     $('#ready_input').attr('disabled', true)
            //                 }else if(xskrMessage.entity == 'UNLOCK_READY_ACTION'){
            //                     //游戏结束，放开Ready勾选框
            //                     $('#ready_input').enable('disabled', false)
            //                 }else if(xskrMessage.entity == 'SINGLE_WOLF_ACTION'){
            //                     //TODO 设定牌垛的选项为可用，玩家选项为不可用，行动按钮的提交目标为孤狼行动
            //                     console.log('single wolf action...')
            //                     $("#action_button").prop("onclick", null).off("click");
            //                     $('#action_button').click(function(){
            //                         var selectedDecks = $("#deck_list_div input:checked").map(function(){return this.value}).get()
            //                         playerActionURL = '/onk/' + roomID + '/singleWolf/check/' + selectedDecks[0]
            //                         ajaxGet(playerActionURL)
            //                     })
            //                 }else if(xskrMessage.entity == 'DRUNK_ACTION'){
            //                     //TODO 设定牌垛的选项为可用，玩家选项为不可用，行动按钮的提交目标为酒鬼行动
            //                     $("#action_button").prop("onclick", null).off("click");
            //                     $('#action_button').click(function(){
            //                         var selectedDecks = $("#deck_list_div input:checked").map(function(){return this.value}).get()
            //                         playerActionURL = '/onk/' + roomID + '/drunk/exchange/' + selectedDecks[0]
            //                         ajaxGet(playerActionURL)
            //                     })
            //                 }else if(xskrMessage.entity == 'ROBBER_ACTION'){
            //                     //TODO 设定牌垛的选项为不可用，玩家选项为可用，行动按钮的提交目标为强盗行动
            //                     $("#action_button").prop("onclick", null).off("click");
            //                     $('#action_button').click(function(){
            //                         var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
            //                         playerActionURL = '/onk/' + roomID + '/robber/snatch/' + selectedSeats[0]
            //                         ajaxGet(playerActionURL)
            //                     })
            //                 }else if(xskrMessage.entity == 'SEER_ACTION'){
            //                     //TODO 设定牌垛的选项为可用，玩家选项为可用，行动按钮的提交目标为预言家行动
            //                     console.log('seer action...')
            //                     $("#action_button").prop("onclick", null).off("click");
            //                     $('#action_button').click(function(){
            //                         var selectedDecks = $("#deck_list_div input:checked").map(function(){return this.value}).get()
            //                         var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
            //                         if(selectedDecks.length == 2){
            //                             //查看牌垛两张牌
            //                             playerActionURL = '/onk/' + roomID + '/seer/check/' + selectedDecks[0] + '/' + selectedDecks[1]
            //                             ajaxGet(playerActionURL)
            //                         }else if(selectedSeats == 1){
            //                             playerActionURL = '/onk/' + roomID + '/seer/check/' + selectedSeats[0]
            //                             ajaxGet(playerActionURL)
            //                         }else{
            //                             //TODO 出错
            //                         }
            //                     })
            //                 }else if(xskrMessage.entity == 'TROUBLEMAKER_ACTION'){
            //                     //TODO 设定牌垛的选项为不可用，玩家选项为不可用，行动按钮的提交目标为捣蛋鬼行动
            //                     $("#action_button").prop("onclick", null).off("click");
            //                     $('#action_button').click(function(){
            //                         var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
            //                         playerActionURL = '/onk/' + roomID + '/troublemaker/exchange/' + selectedSeats[0] + '/' + selectedSeats[1]
            //                         ajaxGet(playerActionURL)
            //                     })
            //                 }else if(xskrMessage.entity == 'VOTE_ACTION'){
            //                     //TODO 设定牌垛的选项为不可用，玩家选项为可用(单选)，行动按钮的提交目标为投票
            //                     $("#action_button").prop("onclick", null).off("click");
            //                     $('#action_button').click(function(){
            //                         var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
            //                         playerActionURL = '/onk/' + roomID + '/vote/' + selectedSeats[0]
            //                         ajaxGet(playerActionURL)
            //                     })
            //                 }
            //             })
            //         })
            //         var topicSock = new SockJS(endpointURL)
            //         var topicStomp = Stomp.over(topicSock)
            //         topicStomp.connect({}, function (frame) {
            //             console.log(frame)
            //             topicStomp.subscribe(topicURL, function (message) {
            //                 var xskrMessage = JSON.parse(message.body)
            //                 showMessage(xskrMessage.message)
            //             })
            //         })
            //     },
            //     error: function(ex){
            //         console.log(JSON.stringify(ex))
            //     }
            // })
            //创建房间
            $('#create_room_button').click(function(){
                $('#create_room_div').show()
                $('#join_room_div').hide()
            })
            //加入房间
            $('#join_room_button').click(function(){
                $('#create_room_div').hide()
                $('#join_room_div').show()
            })
            //创建时勾选
            $('#create_room_div :checkbox').click(function(){
                var size = $('#create_room_div input:checked').length
                $('#apply_create_button').html('(人数:' + size + ') 确定')
                $('#create_room_div').show()
            })
            //确定创建
            $('#apply_create_button').click(function(){
                $('#create_join_div').hide()
                $('#room_div').show()
                var selectedCharacter = $("#create_room_div input:checked").map(function(){return this.value}).get()
                var stringify = JSON.stringify(selectedCharacter)
                $.ajax({
                    url:'/onk/room',
                    type: 'POST',
                    data: stringify,
                    Accept : "application/json",
                    contentType: "application/json",
                    success: function(room){
                        roomInfo(room)
                        joinRoom(room.id)
                    },
                    error:function(ex){
                        console.log(ex);
                    }
                });
            })
            //确定加入
            $('#apply_join_button').click(function(){
                $('#create_join_div').hide()
                $('#room_div').show()
                //根据房间ID取房间信息
                var roomID = $('#room_id_input').val()
                $.ajax({
                    url:'/onk/room/' + roomID,
                    type: 'GET',
                    Accept : "application/json",
                    contentType: "application/json",
                    success: function(room){
                        roomInfo(room)
                        joinRoom(room.id)
                    },
                    error:function(ex){
                        console.log(ex)
                    }
                })
            })

            //准备
            $('#ready_input').click(function(){
                $.ajax({
                    url: '/onk/' + $('#room_id_span').html() + '/ready/' + $("#ready_input").prop('checked'),
                    Accept: 'application/json',
                    contentType: 'application/json',
                    success: function(ready){
                        console.log('ready: ' + ready)
                    },
                    error: function(ex){
                        console.log(JSON.stringify(ex))
                    }
                })
            })

            //清空消息
            $('#clear_message_button').click(function(){
                $('#messages_div').html("")
            })

            //行动
            $('#action_button').click(function(){
                ajaxGet(playerActionURL)
            })
        })
        function roomInfo(room){
            //刷新房间ID信息
            $('#room_id_span').html(room.id)
            //刷新房间座位数量
            $('#seat_count_span').html(room.seatCount)
            //刷新房间卡牌信息
            $('#card_list_div').html('')
            for(key in room.cards){
                $('#card_list_div').append('<div>' + getCardName(room.cards[key]) + '</div>')
            }
            //刷新房间牌垛信息
            $('#deck_list_div').html('')
            for(var i=1;i<=3;i++){
                var id = 'deck_checkbox_' + i
                $('#deck_list_div').append('<div>' + '<input type="checkbox" value="' + i + '" id="'  + id + '"><label for="' + id +'">牌' + i + '</label></div>')
            }
            console.log("create room: " + JSON.stringify(room));
        }
        function joinRoom(roomID){
            //进入房间，并刷新房间玩家信息，订阅该房间的消息
            $.ajax({
                url: '/onk/' + roomID + '/join',
                Accept: 'application/json',
                contentType: 'application/json',
                success: function(joinInfo){
                    console.log("players infomation: " + JSON.stringify(joinInfo))
                    var players = joinInfo['seatPlayerNameMap'];
                    for(var seat in players){
                        var player = players[seat]
                        var id = 'player_checkbox_' + seat
                        $('#player_list_div').append('<div><input type="checkbox" value="' + seat + '" id="' + id + '"><label for="' + id + '">' + seat +'. ' + player + '</label></div>')
                    }
                    var playerName = joinInfo['playerName']
                    $('#who_span').text(playerName)
                    var endpointURL = '/onk/endpoint'
                    var queueURL = '/user/queue/' + roomID
                    var queueSock = new SockJS(endpointURL)
                    var queueStomp = Stomp.over(queueSock)
                    queueStomp.connect('guest', 'guest', function(frame){
                        console.log(frame)
                        queueStomp.subscribe(queueURL, function(message){
                            var xskrMessage = JSON.parse(message.body)
                            showMessage(xskrMessage.message)

                        })
                    })
                    // queueStomp.connect({}, function(frame){
                    //     console.log(frame)
                    //     queueStomp.subscribe(queueURL, function(message){
                    //         var xskrMessage = JSON.parse(message.body)
                    //         showMessage(xskrMessage.message)
                    //         if(xskrMessage.entity == 'LOCK_READY_ACTION'){
                    //             //游戏开始，锁定Ready勾选框
                    //             $('#ready_input').attr('disabled', true)
                    //         }else if(xskrMessage.entity == 'UNLOCK_READY_ACTION'){
                    //             //游戏结束，放开Ready勾选框
                    //             $('#ready_input').enable('disabled', false)
                    //         }else if(xskrMessage.entity == 'SINGLE_WOLF_ACTION'){
                    //             //TODO 设定牌垛的选项为可用，玩家选项为不可用，行动按钮的提交目标为孤狼行动
                    //             console.log('single wolf action...')
                    //             $("#action_button").prop("onclick", null).off("click");
                    //             $('#action_button').click(function(){
                    //                 var selectedDecks = $("#deck_list_div input:checked").map(function(){return this.value}).get()
                    //                 playerActionURL = '/onk/' + roomID + '/singleWolf/check/' + selectedDecks[0]
                    //                 ajaxGet(playerActionURL)
                    //             })
                    //         }else if(xskrMessage.entity == 'DRUNK_ACTION'){
                    //             //TODO 设定牌垛的选项为可用，玩家选项为不可用，行动按钮的提交目标为酒鬼行动
                    //             $("#action_button").prop("onclick", null).off("click");
                    //             $('#action_button').click(function(){
                    //                 var selectedDecks = $("#deck_list_div input:checked").map(function(){return this.value}).get()
                    //                 playerActionURL = '/onk/' + roomID + '/drunk/exchange/' + selectedDecks[0]
                    //                 ajaxGet(playerActionURL)
                    //             })
                    //         }else if(xskrMessage.entity == 'ROBBER_ACTION'){
                    //             //TODO 设定牌垛的选项为不可用，玩家选项为可用，行动按钮的提交目标为强盗行动
                    //             $("#action_button").prop("onclick", null).off("click");
                    //             $('#action_button').click(function(){
                    //                 var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
                    //                 playerActionURL = '/onk/' + roomID + '/robber/snatch/' + selectedSeats[0]
                    //                 ajaxGet(playerActionURL)
                    //             })
                    //         }else if(xskrMessage.entity == 'SEER_ACTION'){
                    //             //TODO 设定牌垛的选项为可用，玩家选项为可用，行动按钮的提交目标为预言家行动
                    //             console.log('seer action...')
                    //             $("#action_button").prop("onclick", null).off("click");
                    //             $('#action_button').click(function(){
                    //                 var selectedDecks = $("#deck_list_div input:checked").map(function(){return this.value}).get()
                    //                 var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
                    //                 if(selectedDecks.length == 2){
                    //                     //查看牌垛两张牌
                    //                     playerActionURL = '/onk/' + roomID + '/seer/check/' + selectedDecks[0] + '/' + selectedDecks[1]
                    //                     ajaxGet(playerActionURL)
                    //                 }else if(selectedSeats == 1){
                    //                     playerActionURL = '/onk/' + roomID + '/seer/check/' + selectedSeats[0]
                    //                     ajaxGet(playerActionURL)
                    //                 }else{
                    //                     //TODO 出错
                    //                 }
                    //             })
                    //         }else if(xskrMessage.entity == 'TROUBLEMAKER_ACTION'){
                    //             //TODO 设定牌垛的选项为不可用，玩家选项为不可用，行动按钮的提交目标为捣蛋鬼行动
                    //             $("#action_button").prop("onclick", null).off("click");
                    //             $('#action_button').click(function(){
                    //                 var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
                    //                 playerActionURL = '/onk/' + roomID + '/troublemaker/exchange/' + selectedSeats[0] + '/' + selectedSeats[1]
                    //                 ajaxGet(playerActionURL)
                    //             })
                    //         }else if(xskrMessage.entity == 'VOTE_ACTION'){
                    //             //TODO 设定牌垛的选项为不可用，玩家选项为可用(单选)，行动按钮的提交目标为投票
                    //             $("#action_button").prop("onclick", null).off("click");
                    //             $('#action_button').click(function(){
                    //                 var selectedSeats = $("#player_list_div input:checked").map(function(){return this.value}).get()
                    //                 playerActionURL = '/onk/' + roomID + '/vote/' + selectedSeats[0]
                    //                 ajaxGet(playerActionURL)
                    //             })
                    //         }
                    //     })
                    // })
                    // var topicURL = '/topic/' + roomID
                    // var topicSock = new SockJS(endpointURL)
                    // var topicStomp = Stomp.over(topicSock)
                    // topicStomp.connect('guest', 'guest', function (frame) {
                    //     console.log(frame)
                    //     topicStomp.subscribe(topicURL, function (message) {
                    //         var xskrMessage = JSON.parse(message.body)
                    //         showMessage(xskrMessage.message)
                    //     })
                    // })
                },
                error: function(ex){
                    console.log(JSON.stringify(ex))
                }
            })
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            console.log("Disconnected");
        }

        function showMessage(message){
            $('#messages_div').append('<div>' + message + '</div>')
        }

        function ajaxGet(url){
            $.ajax({
                url: url,
                type: 'GET',
                Accept : "application/json",
                contentType: "application/json",
                success: function(){
                    console.log('call: ' + url)
                },
                error:function(ex){
                    console.log(ex);
                }
            });
        }

        //获得卡牌中文名称
        function getCardName(card){
            if(card == 'WEREWOLF_1'){
                return '狼人'
            }else if(card == 'WEREWOLF_2'){
                return '狼人'
            }else if(card == 'MINION'){
                return '爪牙'
            }else if(card == 'MASON_1'){
                return '守夜人'
            }else if(card == 'MASON_2'){
                return '守夜人'
            }else if(card == 'ROBBER'){
                return '酒鬼'
            }else if(card == 'SEER'){
                return '预言家'
            }else if(card == 'TANNER'){
                return '皮匠'
            }else if(card == 'TROUBLEMAKER'){
                return '捣蛋鬼'
            }else if(card == 'VILLAGER_1'){
                return '村民'
            }else if(card == 'VILLAGER_2'){
                return '村民'
            }else if(card == 'VILLAGER_3'){
                return '村民'
            }else if(card == 'DRUNK'){
                return '酒鬼'
            }else if(card == 'HUNTER'){
                return '猎人'
            }else if(card == 'INSOMNIAC'){
                return '失眠者'
            }else{
                return card
            }
        }
    </script>
</head>
<body>
    <div id="create_join_div" class="container">
        <div id="create_join_button_div" class="row">
            <button id="create_room_button">创建</button>
            <button id="join_room_button">加入</button><br><br>
        </div>
        <div id="create_room_div" class="col-md-5" hidden>
            <div>
                <div>
                    <div>狼人阵营:</div><br>
                    <div style="margin-left:50px">
                        <input id="cb_werewolf_1" type="checkbox" value="WEREWOLF_1" checked>
                        <label for="cb_werewolf_1">狼人</label>
                        <input id="cb_werewolf_2" type="checkbox" value="WEREWOLF_2">
                        <label for="cb_werewolf_2">狼人</label>
                        <input id="minion" type="checkbox" value="MINION" checked>
                        <label for="minion">爪牙</label>
                    </div><br>
                </div>
                <div>
                    <div>村民阵营:</div><br>
                    <div style="margin-left:50px">
                        <input id="cb_mason_1" type="checkbox" value="MASON_1">
                        <label for="cb_mason_1">守夜人</label>
                        <input id="cb_mason_2" type="checkbox" value="MASON_2">
                        <label for="cb_mason_2">守夜人</label>
                    </div><br>
                    <div style="margin-left:50px">
                        <input id="cb_seer" type="checkbox" value="SEER" checked>
                        <label for="cb_seer">预言家</label>
                        <input id="cb_robber" type="checkbox" value="ROBBER" checked>
                        <label for="cb_robber">盗贼</label>
                        <input id="cb_troublemaker" type="checkbox" value="TROUBLEMAKER" checked>
                        <label for="cb_troublemaker">捣蛋鬼</label>
                    </div><br>
                    <div style="margin-left:50px">
                        <input id="cb_drunk" type="checkbox" value="DRUNK">
                        <label for="cb_drunk">酒鬼</label>
                        <input id="cb_insomniac" type="checkbox" value="INSOMNIAC">
                        <label for="cb_insomniac">失眠者</label>
                        <input id="cb_hunter" type="checkbox" value="HUNTER">
                        <label for="cb_hunter">猎人</label>
                    </div><br>
                    <div style="margin-left:50px">
                        <input id="cb_villager_1" type="checkbox" value="VILLAGER_1">
                        <label for="cb_villager_1">村民</label>
                        <input id="cb_villager_2" type="checkbox" value="VILLAGER_2">
                        <label for="cb_villager_2">村民</label>
                        <input id="cb_villager_3" type="checkbox" value="VILLAGER_3">
                        <label for="cb_villager_3">村民</label>
                    </div><br>
                </div>
                <div>
                    <div>皮匠阵营:</div><br>
                    <div style="margin-left:50px">
                        <input id="cb_tanner" type="checkbox" value="TANNER">
                        <label for="cb_tanner">皮匠</label>
                    </div>
                </div>
            </div>
            <button id="apply_create_button" style="margin-left: 200px">确定</button>
        </div>
        <div id="join_room_div" class="row" hidden>
            <label for="room_id_input">房间号: </label>
            <input type="number" id="room_id_input" value="1"><br><br>
            <button id="apply_join_button" style="margin-left: 200px">确定</button>
        </div>
    </div>
    <div id="room_div" class="container" hidden>
        <div id="room_info_div" class="row">
            <label class="col-md-3"><span id="who_span"></span></label>
            <input type="checkbox" id="ready_input"><label for="ready_input">准备</label>
            <label class="col-md-3">房间号: <span id="room_id_span"></span></label>
            <label class="col-md-3">座位数: <span id="seat_count_span"></span></label>
        </div>

        <div class="row">
            <div id="player_div" class="col-sm-4 col-lg-4 col-md-4 col-xs-4">
                玩家信息:
                <div id="player_list_div">

                </div>
            </div>
            <div id="deck_div" class="col-sm-4 col-lg-4 col-md-4 col-xs-4">
                桌上信息:
                <div id="deck_list_div">

                </div>
            </div>
            <div id="card_div" class="col-sm-4 col-lg-4 col-md-4 col-xs-4">
                卡牌信息:
                <div id="card_list_div">

                </div>
            </div>
        </div>
        <div class="row">
            <button id="action_button">行动</button>
            <button id="clear_message_button">清空消息</button>Message:
            <div id="messages_div"></div>
        </div>
    </div>
</body>
</html>
