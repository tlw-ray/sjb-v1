<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>创建或加入房间</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script>
        var endpointURL = '/onk/endpoint'
        $(document).ready(function () {
            //订阅个人频道
            var queueURL = '/user/queue'
            var queueSock = new SockJS(endpointURL)
            var queueStomp = Stomp.over(queueSock)
            queueStomp.connect({}, function (frame) {
                //记录当前客户端玩家身份
                $('#player_hidden').val(frame['headers']['user-name'])
                queueStomp.subscribe(queueURL, function (message) {
                    var xskrMessage = JSON.parse(message.body)
                    //将收到消息的message显示
                    if (xskrMessage.message != null) {
                        $('#messages_div').append('<div>' + xskrMessage.message + '</div>')
                    }
                    disableAll()
                    //处理个人频道推送的信息
                    processUserQueueAction(xskrMessage)
                })
            })

            $('#create_join_div').show()
            $('#room_div').hide()

            //确定创建新房间
            $('#create_room_button').click(function () {
                $.ajax({
                    url: '/onk/room',
                    type: 'POST',
                    Accept: "application/json",
                    contentType: "application/json",
                    success: function (roomID) {
                        //更新创建的房间ID
                        $('#room_id_number').val(roomID)
                        //加入房间
                        joinRoom()
                    },
                    error: function (ex) {
                        console.log(ex)
                    }
                })
            })

            //确定加入已有房间
            $('#apply_join_button').click(function () {
                //进入指定ID的房间
                var roomID = $('#room_id_number').val()
                joinRoom()
            })

            //创建时勾选角色时计算房间能够容纳的人数(座位数)
            $('#create_room_div :checkbox').click(function () {
                var size = $('#create_room_div input:checked').length
                $('#apply_create_button').html('(人数:' + (size - 3) + ') 确定')
                $('#create_room_div').show()
            })

            $('#config_card_div > :checkbox').each(function(idx, element){
                $(element).bind('click', {}, function(e){
                    var selectedCards = $("#config_card_div input:checked").map(function () {
                        return this.value
                    }).get()
                    var roomID = $('#room_id_number').val()
                    $.ajax({
                        url: '/onk/' + roomID + '/cards',
                        type: 'POST',
                        data: JSON.stringify(selectedCards),
                        Accept: "application/json",
                        contentType: "application/json",
                        success: function () {
                        },
                        error: function (ex) {
                            console.log(ex)
                        }
                    })
                })
            })

            //准备，开始游戏
            $('#ready_checkbox').click(function () {
                //清空之前的获胜信息
                $('.outcome').html('')
                //清空消息栏
                $('#messages_div').html('')
                $.ajax({
                    url: '/onk/' + $('#room_id_span').html() + '/ready/' + $('#ready_checkbox').prop('checked'),
                    Accept: 'application/json',
                    contentType: 'application/json',
                    success: function (ready) {
                        console.log('ready: ' + ready)
                        $('#ready_checkbox').prop('checked', ready)
                    },
                    error: function (ex) {
                        console.log(JSON.stringify(ex))
                    }
                })
            })

            $('#exit_button').click(function(){
                var roomID = $('#room_id_number').val()
                ajaxGet('/onk/' + roomID + '/leave')
                $('#create_join_div').show()
                $('#game_div').hide()
            })

            function joinRoom() {
                var roomID = $('#room_id_number').val()
                //刷新房间牌垛信息
                for(var cardPosition = 0; cardPosition < 3; cardPosition++) {
                    var id = 'deck_button_' + cardPosition
                    var deckButton = $('<button/>', {
                        'id': id,
                        'value': cardPosition,
                        'text': '牌' + cardPosition
                    })
                    deckButton.bind('click', {'cardPosition': cardPosition}, function(e){
                        var url = '/onk/' + roomID + '/deck/' + e.data.cardPosition
                        ajaxGet(url)
                    })
                    $('#deck_div').append(deckButton)
                }

                //加入房间
                $('#room_id_span').html(roomID)
                //进入房间，订阅该房间的消息
                $.ajax({
                    url: '/onk/' + roomID + '/join',
                    Accept: 'application/json',
                    contentType: 'application/json',
                    success: function () {
                        //进入房间后订阅该房间的公共频道
                        var topicURL = '/topic/' + roomID
                        var topicSock = new SockJS(endpointURL)
                        var topicStomp = Stomp.over(topicSock)
                        topicStomp.connect('guest', 'guest', function (frame) {
                            topicStomp.subscribe(topicURL, function (message) {
                                var xskrMessage = JSON.parse(message.body)
                                disableAll()
                                var clientAction = xskrMessage.action
                                if (clientAction == 'ROOM_CHANGED') {
                                    //刷新房间信息
                                    var room = xskrMessage.data
                                    refreshPlayerList(room)
                                }else if (clientAction == 'GAME_FINISH') {
                                    //重置ready供玩家开启新一局游戏
                                    $('#ready_checkbox').prop('checked', false)
                                    $('#ready_checkbox').prop('disabled', false)
                                    //输出玩家输赢状态
                                    for (var idx in xskrMessage.data) {
                                        var data = xskrMessage.data[idx]
                                        var outcomeMessage = getCampName(data.camp)
                                        if (data.win) {
                                            outcomeMessage += ' 获胜 '
                                        } else {
                                            outcomeMessage += ' 失败 '
                                        }
                                        outcomeMessage = outcomeMessage + '(' + getCardName(data.initializeCard) + '->' + getCardName(data.finalCard) + ')'
                                        $('#player_outcome_span_' + data.seat).html(outcomeMessage)
                                    }
                                } else if (clientAction == 'VOTE_ACTION') {
                                    enablePlayersWithoutSelf()
                                }
                                if (xskrMessage.message != null) {
                                    $('#messages_div').append('<div>' + xskrMessage.message + '</div>')
                                }
                            })
                            //初次加入房间找第一个空位坐下
                            var firstEmptySeat = $('#seat_div > div:empty(playername)').first()
                            $(firstEmptySeat).click()
                        })
                    },
                    error: function (ex) {
                        console.log(JSON.stringify(ex))
                        alert('加入失败');
                    }
                })
            }
        })

        function processUserQueueAction(xskrMessage) {
            var clientAction = xskrMessage.action
            if (clientAction == 'ROOM_CHANGED') {
                //刷新房间信息
                var room = xskrMessage.data
                refreshPlayerList(room)
            }else if(clientAction == 'RECONNECT'){
                //断线重连
                //除了刷新房间信息，还需要输出该玩家的关键消息
                var room = xskrMessage.data
                var playerName = $('#player_hidden').val()
                refreshPlayerList(room)
                for(var i in room.players){
                    var player = players[i]
                    if(player['name'] == playerName){
                        var keyMessages = player['keyMessage']
                        //显示本局该玩家所有关键游戏信息
                        var lastXskrMessage
                        for(var j in keyMessages){
                            lastXskrMessage = keyMessages[j]
                            $('#messages_div').append(lastXskrMessage.message + '<br>')
                        }
                        //断线重连根据最后一次clientAction决定行动按钮的具体行为
                        clientAction = lastXskrMessage.action
                        break
                    }
                }
            }else if (clientAction == 'SINGLE_WOLF_ACTION') {
                enableDesktopCards()
                enablePlayersWithoutSelf()
            } else if (clientAction == 'DRUNK_ACTION') {
                enableDesktopCards()
            } else if (clientAction == 'ROBBER_ACTION') {
                enablePlayersWithoutSelf()
            } else if (clientAction == 'SEER_ACTION') {
                enableDesktopCards()
                enablePlayersWithoutSelf()
            } else if (clientAction == 'TROUBLEMAKER_ACTION') {
                enablePlayersWithoutSelf()
            } else if (clientAction == 'VOTE_ACTION') {
                enablePlayersWithoutSelf()
            } else if (clientAction == 'HUNTER_VOTE_ACTION') {
                enablePlayersWithoutSelf()
            } else {
                console.log("Unsupported action: " + clientAction)
            }
        }

        function disableAll(){
            $('input').prop('disabled', true)
            //玩家的DIV不能再点击
            // $('input').prop('onclick', null).off('click')
            // $('div').prop('onclick', null).off('click')
        }

        function enableDesktopCards(){
            $('#deck_div > button').prop('disabled', false)
        }

        function enablePlayersWithoutSelf(){
            $('#seat_div > * > button').prop('disabled', false)
            //不能点自己
            var playerName = $('#player_hidden').val()
            alert($('#seat_div > div[playerName="' + playerName + '"]').length)
            $('#seat_div > div[playerName="' + playerName + '"]').prop('disabled', true)
        }

        function refreshPlayerList(room) {
            $('#create_join_div').hide()
            $('#room_div').show()

            //刷新房间卡牌信息
            $('#config_card_div > input').prop('checked', false)
            for (var i in room.cards) {
                var card = room.cards[i]
                var checkboxName = '#' + card.toLowerCase() + '_checkbox'
                $(checkboxName).prop('checked', true)
            }

            //如果玩家是房主则可以在准备期间修改房间的卡牌设定
            if($('#player_hidden').val() == room.owner){
                $('#config_card_div > :checkbox').prop('disabled', false)
            }

            //ready可用
            $('#ready_checkbox').prop('disabled', false)

            //构建座位区域
            $('#seat_div').html('')
            //建立所有的座位区域
            for (var i = 0; i < room.seatCount; i++) {
                //TODO 修改座位的样式
                var seatDiv = $('<div/>', {
                    'style': 'width:90%; height:60px; text-align: left; background-color: gray; border-style: groove',
                    'id': 'seat_div_' + i
                })
                seatDiv.bind('click', {'seat': i}, function(e){
                    //点击空白座位
                    e.cancelBubble = true
                    e.stopPropagation()     //阻止事件向上传递
                    e.preventDefault()      //放弃默认的行为，例如双击选中
                    var roomID = $('#room_id_span').html()
                    var url = '/onk/' + roomID + '/seat/' + e.data.seat
                    ajaxGet(url)
                })
                $('#seat_div').append(seatDiv)
            }
            //将玩家放置到座位区域上去
            var players = room.players
            for (var idx in players) {
                var player = players[idx]
                var seat = player['seat']
                if(seat != null && seat >= 0 && seat < room.seatCount){
                    //当房主改变房间设定时，可能会出现玩家座位超出可用座位数的情况, 这里保障座位是有效的
                    var playerName = player['name']
                    var ready = player['ready']
                    var playerInfo = seat + '. ' + playerName;
                    var playerButtonID = 'player_button_' + idx;
                    if (playerName == $('#player_hidden').val()) {
                        //标记当前玩家
                        playerInfo = '☺' + playerInfo
                        //刷新当前玩家的准备状态
                        $('#ready_checkbox').prop('checked', ready)
                    } else {
                        //do nothing
                    }

                    if(ready){
                        playerInfo = playerInfo + ' ∞'
                    }else{
                        //do nothing
                    }

                    var playerButton = $('<button/>', {
                        'id': playerButtonID,
                        'text': playerInfo
                    })

                    var outcome = $('<span/>', {
                        'class': 'outcome',
                        'id': 'player_outcome_span_' + seat
                    })

                    $('#seat_div_' + seat).append(playerButton)
                    $('#seat_div_' + seat).append(outcome)
                    $('#seat_div_' + seat).attr('playerName', playerName)
                }
            }
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect()
            }
            console.log("Disconnected")
        }

        function ajaxGet(url) {
            console.log('call: ' + url)
            $.ajax({
                url: url,
                type: 'GET',
                Accept: "application/json",
                contentType: "application/json",
                success: function (data) {
                    return data
                },
                error: function (ex) {
                    console.log(ex)
                }
            });
        }

        //获得阵营中文名称
        function getCampName(camp) {
            if (camp == 'TANNER') {
                return '皮匠'
            } else if (camp == 'WOLF') {
                return '狼人'
            } else if (camp == 'VILLAGER') {
                return '村民'
            } else {
                return camp
            }
        }

        //获得卡牌中文名称
        function getCardName(card) {
            if (card == 'WEREWOLF_1') {
                return '狼人'
            } else if (card == 'WEREWOLF_2') {
                return '狼人'
            } else if (card == 'MINION') {
                return '爪牙'
            } else if (card == 'MASON_1') {
                return '守夜人'
            } else if (card == 'MASON_2') {
                return '守夜人'
            } else if (card == 'ROBBER') {
                return '强盗'
            } else if (card == 'SEER') {
                return '预言家'
            } else if (card == 'TANNER') {
                return '皮匠'
            } else if (card == 'TROUBLEMAKER') {
                return '捣蛋鬼'
            } else if (card == 'VILLAGER_1') {
                return '村民'
            } else if (card == 'VILLAGER_2') {
                return '村民'
            } else if (card == 'VILLAGER_3') {
                return '村民'
            } else if (card == 'DRUNK') {
                return '酒鬼'
            } else if (card == 'HUNTER') {
                return '猎人'
            } else if (card == 'INSOMNIAC') {
                return '失眠者'
            } else {
                return card
            }
        }
    </script>
    <style>
        .logo {
            width: 100%;
            text-align: center;
            margin: 20px 0;
        }

        button {
            width: 120px;
            height: 40px;
        }

        #imgs {
            width: 100%;
            text-align: center;
            margin: 20px 0;
        }

        #imgs > img {
            width: 60px;
            height: 60px;
            margin-left: 10px;
        }
        #config_card_div > label{
            margin-right: 20px
        }
    </style>
</head>
<body>
<!--
结构:
create_join_div
room_div
	config_div
		config_card_div
	info_div
	game_div
		seat_div
		message_div
		card_div
-->
<input type="hidden" id="player_hidden">
<div id="create_join_div" class="container">
    <!--<img class="logo" src="logo.jpg">-->
    <button id="create_room_button">创建房间</button><hr>
    <label for="room_id_number">房间号:</label>
    <input type="number" id="room_id_number" value="0"><br>
    <button id="apply_join_button">加入房间</button>
</div>
<div id="room_div" class="container" hidden>
    <div id="config_card_div" class="row">
        <input type="checkbox" id="doppelganger_checkbox" value="DOPPELGANGER" disabled>
        <label for="doppelganger_checkbox">化</label>
        <input type="checkbox" id="werewolf_1_checkbox" value="WEREWOLF_1">
        <label for="werewolf_1_checkbox">狼</label>
        <input type="checkbox" id="werewolf_2_checkbox" value="WEREWOLF_2">
        <label for="werewolf_2_checkbox">狼</label>
        <input type="checkbox" id="minion_checkbox" value="MINION">
        <label for="minion_checkbox">爪</label>
        <input type="checkbox" id="seer_checkbox" value="SEER">
        <label for="seer_checkbox">预</label>
        <input type="checkbox" id="robber_checkbox" value="ROBBER">
        <label for="robber_checkbox">盗</label>
        <input type="checkbox" id="troublemaker_checkbox" value="TROUBLEMAKER">
        <label for="troublemaker_checkbox">捣</label>
        <input type="checkbox" id="insomniac_checkbox" value="INSOMNIAC">
        <label for="insomniac_checkbox">失</label>
        <input type="checkbox" id="hunter_checkbox" value="HUNTER">
        <label for="hunter_checkbox">猎</label>
        <input type="checkbox" id="drunk_checkbox" value="DRUNK">
        <label for="drunk_checkbox">酒</label>
        <input type="checkbox" id="mason_1_checkbox" value="MASON_1">
        <label for="mason_1_checkbox">守</label>
        <input type="checkbox" id="mason_2_checkbox" value="MASON_2">
        <label for="mason_2_checkbox">守</label>
        <input type="checkbox" id="villager_1_checkbox" value="VILLAGER_1">
        <label for="villager_1_checkbox">村</label>
        <input type="checkbox" id="villager_2_checkbox" value="VILLAGER_2">
        <label for="villager_2_checkbox">村</label>
        <input type="checkbox" id="villager_3_checkbox" value="VILLAGER_3">
        <label for="villager_3_checkbox">村</label>
        <input type="checkbox" id="tanner_checkbox" value="TANNER">
        <label for="tanner_checkbox">厌</label>
    </div>
    <div id="info_div" class="row">
        <div class="col-sm-4 col-lg-4 col-md-4 col-xs-4">
            <input type="checkbox" id="ready_checkbox">
            <label for="ready_checkbox">准备</label>
        </div>
        <div class="col-sm-2 col-lg-2 col-md-2 col-xs-2">
            <label >房间号: <span id="room_id_span"></span></label>
        </div>
        <div class="col-sm-6 col-lg-6 col-md-6 col-xs-6">
            <button id="exit_button">退出</button>
        </div>
    </div>

    <div id="game_div" class="row">
        <div id="seat_div" class="col-sm-4 col-lg-4 col-md-4 col-xs-4">

        </div>
        <div id="messages_div" class="col-sm-5 col-lg-5 col-md-5 col-xs-5"></div>
        <div id="deck_div" class="col-sm-2 col-lg-2 col-md-2 col-xs-2">

        </div>
    </div>
</div>
</body>
</html>
